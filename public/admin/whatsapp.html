<!DOCTYPE html>
<html lang="pt-BR" data-theme="retro">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot - DeliveryHub</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #d9432e;
            --secondary: #ffb800;
            --bg: #fff9f0;
            --dark: #1a1a1a;
            --card: #ffffff;
            --text: #1a1a1a;
            --text-muted: #666666;
            --border: #1a1a1a;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --shadow-offset: 6px;
            --radius: 20px;
            --whatsapp: #25d366;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            background-image: radial-gradient(circle at 20px 20px, rgba(217, 67, 46, 0.03) 2px, transparent 2px);
            background-size: 40px 40px;
        }

        .layout {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--card);
            border-right: 3px solid var(--dark);
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            color: var(--primary);
            letter-spacing: 2px;
            text-shadow: 3px 3px 0 var(--secondary);
            margin-bottom: 32px;
            text-decoration: none;
            display: block;
        }

        .nav-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 24px 0 12px 12px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            color: var(--text);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 4px;
            border: 2px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg);
            border-color: var(--dark);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            border: 2px solid var(--dark);
            box-shadow: 4px 4px 0 var(--dark);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .main {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            max-width: 1000px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-muted);
            font-weight: 500;
        }

        .btn {
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            border: 3px solid var(--dark);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.85rem;
            font-family: 'Outfit', sans-serif;
            color: var(--text);
            background: var(--card);
            text-decoration: none;
        }

        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 4px 4px 0 var(--dark);
        }

        .btn-whatsapp {
            background: var(--whatsapp);
            color: white;
        }

        .btn-secondary {
            background: var(--bg);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .card {
            background: var(--card);
            border: 3px solid var(--dark);
            border-radius: var(--radius);
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--dark);
        }

        .card-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: 1px;
        }

        .status-badge {
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.8rem;
            border: 2px solid var(--dark);
            letter-spacing: 1px;
            display: inline-block;
            margin-left: auto;
        }

        .status-connected {
            background: var(--success);
            color: white;
        }

        .status-disconnected {
            background: var(--danger);
            color: white;
        }

        .status-initializing {
            background: var(--warning);
            color: var(--dark);
        }

        .qr-placeholder {
            width: 250px;
            height: 250px;
            background: var(--bg);
            border: 3px dashed var(--dark);
            border-radius: 16px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            gap: 16px;
        }

        .qr-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 16px;
            background: var(--bg);
            border: 3px solid var(--dark);
            border-radius: 12px;
            color: var(--text);
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
        }

        .toggle-switch {
            width: 60px;
            height: 32px;
            background: var(--text-muted);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: 0.3s;
            border: 2px solid var(--dark);
            display: inline-block;
            vertical-align: middle;
            margin-right: 12px;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: 0.3s;
            border: 2px solid var(--dark);
        }

        .toggle-switch.active::after {
            left: 30px;
        }

        .info-box {
            background: #e0e7ff;
            border: 3px solid var(--dark);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
            font-size: 0.9rem;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .groups-list {
            margin-top: 16px;
            border: 3px solid var(--dark);
            border-radius: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .group-item {
            padding: 12px;
            border-bottom: 2px solid var(--dark);
            cursor: pointer;
            background: var(--bg);
        }

        .group-item:hover {
            background: var(--card);
        }

        .group-item.selected {
            background: var(--secondary);
            color: var(--dark);
            font-weight: 700;
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        .mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 0 var(--dark);
        }

        .mode-card.active {
            background: var(--secondary) !important;
            box-shadow: 4px 4px 0 var(--dark);
        }
    </style>
</head>

<body>
    <div class="layout">
        <aside class="sidebar">
            <a href="./" class="logo">DeliveryHub</a>
            <nav>
                <div class="nav-label">Menu</div>
                <a href="./" class="nav-item"><i class="fas fa-home"></i> Dashboard</a>
                <a href="quadro" class="nav-item"><i class="fas fa-columns"></i> Quadro de Pedidos</a>
                <a href="produtos" class="nav-item"><i class="fas fa-box"></i> Produtos</a>
                <a href="categorias" class="nav-item"><i class="fas fa-tags"></i> Categorias</a>
                <a href="adicionais" class="nav-item"><i class="fas fa-plus-circle"></i> Adicionais</a>

                <div class="nav-label">IA & Automa√ß√£o</div>
                <a href="whatsapp" class="nav-item active"><i class="fab fa-whatsapp"></i> WhatsApp</a>
                <a href="mapeamentos" class="nav-item"><i class="fas fa-link"></i> Mapeamentos</a>
                <a href="ia-sugestoes" class="nav-item"><i class="fas fa-brain"></i> Sugest√µes IA</a>

                <div class="nav-label">Configuracoes</div>
                <a href="config" class="nav-item"><i class="fas fa-cog"></i> Configuracoes</a>
            </nav>
        </aside>

        <main class="main">
            <div class="header">
                <div>
                    <h1>WhatsApp Bot</h1>
                    <p>Configure o atendimento automatico</p>
                </div>
                <a href="config" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Voltar</a>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-plug" style="color: var(--primary);"></i> Status da Conexao
                    <div id="statusBadge" class="status-badge status-initializing">Verificando...</div>
                </div>

                <div id="qrSection" style="display: none; text-align: center;">
                    <div class="qr-placeholder" id="qrContainer">
                        <i class="fas fa-spinner spinner fa-2x"></i>
                        <span>Gerando QR Code...</span>
                    </div>
                    <p>Escaneie o QR Code com seu WhatsApp Conectado.</p>
                </div>

                <div id="connectedSection" style="display: none; text-align: center; padding: 20px;">
                    <div style="font-size: 4rem; color: var(--success); margin-bottom: 16px;"><i
                            class="fas fa-check-circle"></i></div>
                    <h3 style="font-family: 'Bebas Neue'; font-size: 2rem;">Conectado!</h3>
                    <p>O bot esta ativo e pronto para uso.</p>
                </div>

                <div style="margin-top: 24px; display: flex; justify-content: center; gap: 16px; flex-wrap: wrap;">
                    <button class="btn btn-whatsapp" id="btnConnect" onclick="initializeWhatsApp()">
                        <i class="fab fa-whatsapp"></i> CONECTAR
                    </button>
                    <button class="btn btn-secondary" id="btnRestart" onclick="restartWhatsApp()"
                        style="display: none;">
                        <i class="fas fa-sync"></i> REINICIAR
                    </button>
                    <button class="btn btn-danger" id="btnDisconnect" onclick="disconnectWhatsApp()"
                        style="display: none;">
                        <i class="fas fa-power-off"></i> DESCONECTAR
                    </button>
                    <button class="btn" id="btnReset" onclick="resetConnection()"
                        style="display: none; background-color: #dc2626; color: white; border: 2px solid #991b1b;">
                        <i class="fas fa-trash-alt"></i> RESETAR (NOVO QR)
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-robot"></i> Configuracoes</div>

                <div class="form-group">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <div class="toggle-switch" id="botToggle" onclick="toggleBot()"></div>
                        <label style="margin: 0; cursor: pointer;" onclick="toggleBot()">Habilitar Bot</label>
                    </div>
                    <small style="color: var(--text-muted);">O bot respondera automaticamente com o cardapio.</small>
                </div>

                <div class="form-group">
                    <label>ID do Grupo de Pedidos</label>
                    <div style="display: flex; gap: 12px;">
                        <input type="text" id="groupId" placeholder="123456@g.us">
                        <button class="btn btn-secondary" id="btnLoadGroups" onclick="loadGroups()"
                            title="Listar grupos"><i class="fas fa-list"></i></button>
                    </div>
                    <div id="groupsList" class="groups-list"></div>
                </div>

                <div class="form-group">
                    <label>URL Base da Loja (Usada nos links do Bot)</label>
                    <div style="display: flex; gap: 12px;">
                        <input type="text" id="siteUrl" placeholder="https://seu-dominio.com">
                        <button class="btn btn-secondary" onclick="loadStoreLink()" title="Auto-detectar"><i
                                class="fas fa-magic"></i></button>
                    </div>
                    <small style="color: var(--text-muted);">Defina o endere√ßo p√∫blico da sua loja. Deixe em branco para
                        usar o autom√°tico.</small>
                </div>

                <div style="text-align: right; display: flex; gap: 12px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="openMessageConfig()"><i class="fas fa-comment-alt"></i>
                        MENSAGENS DO BOT</button>
                    <button class="btn btn-primary" onclick="saveSettings()"><i class="fas fa-save"></i> SALVAR
                        CONFIGURACOES</button>
                </div>
            </div>

            <!-- Card de Modo de Pedido -->
            <div class="card" style="border-color: #10b981;">
                <div class="card-title" style="color: #10b981;">
                    <i class="fas fa-shopping-cart"></i> Modo de Pedido
                    <span id="orderModeBadge"
                        style="background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; margin-left: 12px;">LINK</span>
                </div>

                <div class="info-box"
                    style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); margin-bottom: 20px;">
                    <i class="fas fa-info-circle" style="color: #10b981; font-size: 1.5rem;"></i>
                    <div>
                        <strong>Escolha como os clientes fazem pedidos</strong><br>
                        <small>O bot pode enviar um link para o card√°pio ou aceitar pedidos por conversa!</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Modo de Opera√ß√£o</label>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <div id="modeLinkCard" onclick="selectOrderMode('link')" class="mode-card active"
                            style="flex: 1; min-width: 200px; padding: 16px; border: 3px solid var(--dark); border-radius: 12px; cursor: pointer; background: var(--bg); transition: all 0.2s;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <i class="fas fa-link" style="font-size: 1.5rem; color: #3b82f6;"></i>
                                <strong>Modo Link</strong>
                            </div>
                            <small style="color: var(--text-muted);">Cliente recebe link do card√°pio e faz pedido pela
                                p√°gina web.</small>
                        </div>
                        <div id="modeDirectCard" onclick="selectOrderMode('direct')" class="mode-card"
                            style="flex: 1; min-width: 200px; padding: 16px; border: 3px solid var(--dark); border-radius: 12px; cursor: pointer; background: var(--bg); transition: all 0.2s;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <i class="fas fa-comments" style="font-size: 1.5rem; color: #10b981;"></i>
                                <strong>Modo H√≠brido</strong>
                            </div>
                            <small style="color: var(--text-muted);">
                                O rob√¥ conversa pelo WhatsApp <strong>E TAMB√âM</strong> envia o link do card√°pio.
                            </small>
                        </div>
                        <div id="modeAIEmployeeCard" onclick="selectOrderMode('funcionario_ia')" class="mode-card"
                            style="flex: 1; min-width: 200px; padding: 16px; border: 3px solid var(--dark); border-radius: 12px; cursor: pointer; background: var(--bg); transition: all 0.2s;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                <i class="fas fa-robot" style="font-size: 1.5rem; color: #8b5cf6;"></i>
                                <strong>Funcion√°rio IA</strong>
                                <span
                                    style="background: linear-gradient(135deg, #8b5cf6, #d946ef); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.6rem;">NOVO</span>
                            </div>
                            <small style="color: var(--text-muted);">
                                IA local (Ollama) conversa e anota pedidos automaticamente.
                                <br><span style="color: #8b5cf6;">Sem custo de API!</span>
                            </small>
                        </div>
                    </div>
                    <small style="color: var(--text-muted); margin-top: 8px; display: block;">
                        <i class="fas fa-lightbulb" style="color: #f59e0b;"></i>
                        <strong>Dica:</strong> O Funcion√°rio IA usa Ollama local para atendimento 100% autom√°tico!
                    </small>
                </div>

                <div id="directModeSettings" style="display: none;">
                    <hr style="border: none; border-top: 2px dashed var(--dark); margin: 20px 0;">
                    <div class="form-group">
                        <label><i class="fas fa-key" style="color: #8b5cf6;"></i> Chave PIX (para pagamentos)</label>
                        <input type="text" id="pixKeyDirect" placeholder="Sua chave PIX (CPF, email, telefone...)">
                        <small style="color: var(--text-muted);">Ser√° exibida quando cliente escolher pagamento via
                            PIX.</small>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-truck" style="color: #f59e0b;"></i> Taxa de Entrega Padr√£o (R$)</label>
                        <input type="number" id="deliveryFeeDirect" placeholder="5.00" step="0.50" min="0">
                        <small style="color: var(--text-muted);">Valor cobrado para entregas no modo direto.</small>
                    </div>
                </div>

                <!-- Configura√ß√µes do Funcion√°rio IA -->
                <div id="aiEmployeeSettings" style="display: none;">
                    <hr style="border: none; border-top: 2px dashed #8b5cf6; margin: 20px 0;">
                    <div class="info-box"
                        style="background: linear-gradient(135deg, #ede9fe, #fce7f3); margin-bottom: 16px;">
                        <i class="fas fa-robot" style="color: #8b5cf6; font-size: 1.5rem;"></i>
                        <div>
                            <strong>Funcion√°rio IA com Ollama</strong><br>
                            <small>Usa LLMs locais para conversar e anotar pedidos. Sem custo por mensagem!</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-user" style="color: #8b5cf6;"></i> Nome do Atendente</label>
                        <input type="text" id="aiEmployeeName" placeholder="Ana" value="Ana">
                        <small style="color: var(--text-muted);">O nome que a IA usar√° para se apresentar.</small>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-theater-masks" style="color: #8b5cf6;"></i> Personalidade</label>
                        <select id="aiEmployeePersonality">
                            <option value="friendly">üòä Simp√°tico (usa emojis, tom informal)</option>
                            <option value="professional">üíº Profissional (formal e objetivo)</option>
                            <option value="casual">ü§ô Casual (descontra√≠do)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-server" style="color: #8b5cf6;"></i> URL do Ollama</label>
                        <input type="text" id="aiOllamaUrl" placeholder="http://localhost:11434"
                            value="http://localhost:11434">
                        <small style="color: var(--text-muted);">Endere√ßo do servidor Ollama (local ou remoto).</small>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-brain" style="color: #8b5cf6;"></i> Modelo</label>
                        <select id="aiOllamaModel">
                            <option value="llama3:8b">Llama 3 (8B) - Recomendado</option>
                            <option value="mistral:7b">Mistral (7B) - R√°pido</option>
                            <option value="qwen2:7b">Qwen 2 (7B) - Multil√≠ngue</option>
                            <option value="phi3:mini">Phi 3 Mini - Leve</option>
                        </select>
                        <small style="color: var(--text-muted);">Escolha o modelo de IA. Llama 3 oferece melhor
                            equil√≠brio.</small>
                    </div>

                    <div class="form-group" style="display: flex; gap: 12px;">
                        <button class="btn" style="background: #8b5cf6; color: white;" onclick="testOllamaConnection()">
                            <i class="fas fa-plug"></i> TESTAR CONEX√ÉO
                        </button>
                    </div>

                    <div id="ollamaStatus" style="display: none; padding: 12px; border-radius: 12px; margin-top: 12px;">
                    </div>
                </div>

                <div style="text-align: right; margin-top: 16px;">
                    <button class="btn" style="background: #10b981; color: white;" onclick="saveOrderMode()">
                        <i class="fas fa-save"></i> SALVAR MODO
                    </button>
                </div>
            </div>

            <!-- Card de IA -->
            <div class="card" style="border-color: #8b5cf6;">
                <div class="card-title" style="color: #8b5cf6;">
                    <i class="fas fa-brain"></i> Bot com IA (Premium)
                    <span id="aiProviderBadge"
                        style="background: linear-gradient(135deg, #8b5cf6, #d946ef); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; margin-left: 12px;">GROQ</span>
                </div>

                <div class="info-box"
                    style="background: linear-gradient(135deg, #ede9fe, #fce7f3); margin-bottom: 20px;">
                    <i class="fas fa-magic" style="color: #8b5cf6; font-size: 1.5rem;"></i>
                    <div>
                        <strong>Atendimento por IA</strong><br>
                        <small>O bot anota pedidos direto pelo WhatsApp, sem precisar de link!</small>
                    </div>
                </div>

                <div class="form-group">
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <div class="toggle-switch" id="aiToggle" onclick="toggleAI()" style="background: #8b5cf6;">
                        </div>
                        <label style="margin: 0; cursor: pointer;" onclick="toggleAI()">Habilitar Bot com IA</label>
                    </div>
                    <small style="color: var(--text-muted);">Quando ativado, o bot usara IA para anotar pedidos via
                        conversa.</small>
                </div>

                <div id="aiConfigSection" style="display: none;">
                    <div class="form-group">
                        <label><i class="fas fa-robot"></i> Provedor de IA</label>
                        <select id="aiProvider" onchange="updateProviderUI()">
                            <option value="groq">Groq (Llama 3) - Recomendado</option>
                            <option value="gemini">Google Gemini</option>
                        </select>
                        <small style="color: var(--text-muted);" id="providerHint">
                            Groq: 30 req/min gratis | Gemini: 20 req/dia gratis
                        </small>
                    </div>

                    <div class="form-group">
                        <label><i class="fas fa-key"></i> <span id="apiKeyLabel">Chave API Groq</span></label>
                        <input type="password" id="aiApiKey" placeholder="Cole sua chave da API">
                        <small style="color: var(--text-muted);">
                            <span id="apiKeyHint">Obtenha em <a href="https://console.groq.com" target="_blank"
                                    style="color: #8b5cf6;">console.groq.com</a></span>
                        </small>
                    </div>

                    <div class="form-group" style="display: flex; gap: 12px;">
                        <button class="btn" style="background: linear-gradient(135deg, #8b5cf6, #d946ef); color: white;"
                            onclick="testAI()">
                            <i class="fas fa-flask"></i> TESTAR IA
                        </button>
                        <button class="btn btn-secondary" onclick="saveAISettings()">
                            <i class="fas fa-save"></i> SALVAR IA
                        </button>
                    </div>

                    <div id="aiStatus" style="display: none; padding: 12px; border-radius: 12px; margin-top: 12px;">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';

        let pollInterval = null;
        let isBotEnabled = false;

        // Extrair slug da URL para contexto do tenant
        const TENANT_SLUG = window.location.pathname.split('/loja/')[1]?.split('/')[0] || '';
        const API_HEADERS = { 'Authorization': `Bearer ${token}`, 'X-Tenant-Slug': TENANT_SLUG };

        async function init() {
            await loadStatus();
            await loadSettings();
            loadStoreLink();
        }

        async function loadStatus() {
            try {
                const res = await fetch('/api/whatsapp/status', { headers: API_HEADERS });
                const data = await res.json();
                updateStatusUI(data);
            } catch (error) { console.error(error); }
        }

        function updateStatusUI(data) {
            const badge = document.getElementById('statusBadge');
            const qrSection = document.getElementById('qrSection');
            const connectedSection = document.getElementById('connectedSection');
            const btnConnect = document.getElementById('btnConnect');
            const btnRestart = document.getElementById('btnRestart');
            const btnDisconnect = document.getElementById('btnDisconnect');

            if (data.connected) {
                badge.textContent = 'CONECTADO';
                badge.className = 'status-badge status-connected';
                qrSection.style.display = 'none';
                connectedSection.style.display = 'block';
                btnConnect.style.display = 'none';
                btnRestart.style.display = 'inline-flex';
                btnDisconnect.style.display = 'inline-flex';
                btnReset.style.display = 'inline-flex';
                if (pollInterval) { clearInterval(pollInterval); pollInterval = null; }
            } else if (data.qrAvailable || data.status === 'initializing') {
                badge.textContent = 'AGUARDANDO SCAN';
                badge.className = 'status-badge status-initializing';
                qrSection.style.display = 'block';
                connectedSection.style.display = 'none';
                btnConnect.style.display = 'none';
                btnRestart.style.display = 'inline-flex';
                btnDisconnect.style.display = 'none';
                btnReset.style.display = 'inline-flex';
                if (data.qrAvailable) loadQRCode();
            } else {
                badge.textContent = 'DESCONECTADO';
                badge.className = 'status-badge status-disconnected';
                qrSection.style.display = 'none';
                connectedSection.style.display = 'none';
                btnConnect.style.display = 'inline-flex';
                btnRestart.style.display = 'none';
                btnDisconnect.style.display = 'none';
                btnReset.style.display = 'inline-flex';
            }
        }

        async function loadQRCode() {
            try {
                const res = await fetch('/api/whatsapp/qr', { headers: API_HEADERS });
                const data = await res.json();
                const container = document.getElementById('qrContainer');
                if (data.available && data.qrCode) {
                    container.innerHTML = `<img src="${data.qrCode}" alt="QR Code">`;
                }
            } catch (e) { console.error(e); }
        }

        async function initializeWhatsApp() {
            const btn = document.getElementById('btnConnect');
            btn.innerHTML = '<i class="fas fa-spinner spinner"></i> INICIANDO...';
            btn.disabled = true;
            try {
                const res = await fetch('/api/whatsapp/initialize', { method: 'POST', headers: API_HEADERS });
                const data = await res.json();
                if (data.success) {
                    pollInterval = setInterval(loadStatus, 3000);
                    loadStatus();
                }
            } catch (e) { alert('Erro ao iniciar'); }
            btn.disabled = false;
        }

        async function restartWhatsApp() {
            if (!confirm('Reiniciar conex√£o?')) return;
            try {
                await fetch('/api/whatsapp/restart', { method: 'POST', headers: API_HEADERS });
                pollInterval = setInterval(loadStatus, 3000);
                loadStatus();
            } catch (e) { alert('Erro'); }
        }

        async function disconnectWhatsApp() {
            if (!confirm('Desconectar?')) return;
            try {
                await fetch('/api/whatsapp/disconnect', { method: 'POST', headers: API_HEADERS });
                loadStatus();
            } catch (e) { alert('Erro'); }
        }

        async function resetConnection() {
            if (!confirm('ATEN√á√ÉO: Isso ir√° apagar a sess√£o atual e desconectar o bot.\nVoc√™ precisar√° escanear o QR Code novamente.\n\nDeseja continuar?')) return;

            const btn = document.getElementById('btnReset');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner spinner"></i> RESETANDO...';
            btn.disabled = true;

            try {
                const res = await fetch('/api/whatsapp/reset', { method: 'POST', headers: API_HEADERS });
                const data = await res.json();

                if (data.success) {
                    alert('Conex√£o resetada! Aguarde o novo QR Code aparecer.');
                    // For√ßar recarregamento do status
                    pollInterval = setInterval(loadStatus, 3000);
                    loadStatus();
                } else {
                    alert('Erro: ' + (data.error || 'Falha ao resetar'));
                }
            } catch (e) {
                console.error(e);
                alert('Erro ao resetar conex√£o');
            }

            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/tenants/me', { headers: API_HEADERS });
                const data = await res.json();
                if (data.settings) {
                    isBotEnabled = data.settings.whatsappBotEnabled || false;
                    document.getElementById('botToggle').classList.toggle('active', isBotEnabled);
                    document.getElementById('groupId').value = data.settings.whatsappGroupId || '';
                    document.getElementById('siteUrl').value = data.settings.siteUrl || '';

                    // Carregar modo de pedido
                    const orderMode = data.settings.whatsappOrderMode || 'link';
                    selectOrderMode(orderMode, false);
                    document.getElementById('pixKeyDirect').value = data.settings.pixKey || '';
                    document.getElementById('deliveryFeeDirect').value = data.settings.deliveryFee || '';
                }
            } catch (e) { }
        }

        function toggleBot() {
            isBotEnabled = !isBotEnabled;
            document.getElementById('botToggle').classList.toggle('active', isBotEnabled);
        }

        async function saveSettings() {
            try {
                await fetch('/api/whatsapp/settings', {
                    method: 'PUT',
                    headers: { ...API_HEADERS, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        whatsappBotEnabled: isBotEnabled,
                        whatsappGroupId: document.getElementById('groupId').value,
                        siteUrl: document.getElementById('siteUrl').value.trim()
                    })
                });
                alert('Configura√ß√µes salvas!');
            } catch (e) { alert('Erro ao salvar'); }
        }

        async function loadGroups() {
            const btn = document.getElementById('btnLoadGroups');
            btn.innerHTML = '<i class="fas fa-spinner spinner"></i>';
            try {
                const res = await fetch('/api/whatsapp/groups', { headers: API_HEADERS });
                const groups = await res.json();
                const list = document.getElementById('groupsList');
                list.style.display = 'block';
                if (groups.length) {
                    list.innerHTML = groups.map(g => `
                        <div class="group-item" onclick="selectGroup('${g.id}')">
                            <div style="font-weight:700;">${g.name}</div>
                            <div style="font-size:0.8rem; color:var(--text-muted);">${g.id}</div>
                        </div>
                    `).join('');
                } else {
                    list.innerHTML = '<div style="padding:12px;">Nenhum grupo encontrado</div>';
                }
            } catch (e) { alert('Erro ao carregar grupos'); }
            btn.innerHTML = '<i class="fas fa-list"></i>';
        }

        function selectGroup(id) {
            document.getElementById('groupId').value = id;
            document.getElementById('groupsList').style.display = 'none';
        }

        async function loadStoreLink() {
            try {
                const res = await fetch('/api/tenants/me', { headers: API_HEADERS });
                const data = await res.json();
                document.getElementById('storeLink').value = `${window.location.origin}/loja/${data.slug}`;
            } catch (e) { }
        }

        function copyLink() {
            const el = document.getElementById('storeLink');
            el.select();
            document.execCommand('copy');
            alert('Copiado!');
        }

        // ========================================
        // Funcoes de Modo de Pedido
        // ========================================
        let currentOrderMode = 'link';

        function selectOrderMode(mode, animate = true) {
            currentOrderMode = mode;

            // Atualizar cards visuais
            document.getElementById('modeLinkCard').classList.toggle('active', mode === 'link');
            document.getElementById('modeDirectCard').classList.toggle('active', mode === 'direct');
            document.getElementById('modeAIEmployeeCard')?.classList.toggle('active', mode === 'funcionario_ia');

            // Atualizar badge
            const badge = document.getElementById('orderModeBadge');
            if (mode === 'direct') {
                badge.textContent = 'H√çBRIDO';
                badge.style.background = '#10b981';
            } else if (mode === 'funcionario_ia') {
                badge.textContent = 'FUNCION√ÅRIO IA';
                badge.style.background = 'linear-gradient(135deg, #8b5cf6, #d946ef)';
            } else {
                badge.textContent = 'LINK';
                badge.style.background = '#3b82f6';
            }

            // Mostrar/esconder configura√ß√µes extras
            document.getElementById('directModeSettings').style.display = mode === 'direct' ? 'block' : 'none';
            document.getElementById('aiEmployeeSettings').style.display = mode === 'funcionario_ia' ? 'block' : 'none';
        }

        async function saveOrderMode() {
            try {
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner spinner"></i> SALVANDO...';
                btn.disabled = true;

                // Configura√ß√µes do Funcion√°rio IA
                const aiEmployeeConfig = {
                    enabled: currentOrderMode === 'funcionario_ia',
                    employeeName: document.getElementById('aiEmployeeName')?.value || 'Ana',
                    personality: document.getElementById('aiEmployeePersonality')?.value || 'friendly',
                    ollamaUrl: document.getElementById('aiOllamaUrl')?.value || 'http://localhost:11434',
                    model: document.getElementById('aiOllamaModel')?.value || 'llama3:8b'
                };

                await fetch('/api/whatsapp/settings', {
                    method: 'PUT',
                    headers: { ...API_HEADERS, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        whatsappOrderMode: currentOrderMode,
                        pixKey: document.getElementById('pixKeyDirect').value.trim(),
                        deliveryFee: parseFloat(document.getElementById('deliveryFeeDirect').value) || 0,
                        aiEmployee: aiEmployeeConfig
                    })
                });

                btn.innerHTML = '<i class="fas fa-check"></i> SALVO!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            } catch (e) {
                alert('Erro ao salvar');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Testar conex√£o com Ollama
        async function testOllamaConnection() {
            const statusEl = document.getElementById('ollamaStatus');
            const url = document.getElementById('aiOllamaUrl')?.value || 'http://localhost:11434';

            statusEl.style.display = 'block';
            statusEl.innerHTML = '<i class="fas fa-spinner spinner"></i> Testando conex√£o com Ollama...';
            statusEl.style.background = '#fef3c7';
            statusEl.style.color = '#92400e';

            try {
                const res = await fetch('/api/whatsapp/test-ollama', {
                    method: 'POST',
                    headers: { ...API_HEADERS, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ollamaUrl: url })
                });
                const data = await res.json();

                if (data.online) {
                    statusEl.innerHTML = `<i class="fas fa-check-circle"></i> <strong>Conectado!</strong><br>
                        Modelos dispon√≠veis: ${data.models?.slice(0, 5).join(', ') || 'Nenhum'}`;
                    statusEl.style.background = '#d1fae5';
                    statusEl.style.color = '#065f46';
                } else {
                    statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> <strong>Erro:</strong> ${data.error || 'N√£o foi poss√≠vel conectar'}`;
                    statusEl.style.background = '#fee2e2';
                    statusEl.style.color = '#991b1b';
                }
            } catch (e) {
                statusEl.innerHTML = `<i class="fas fa-exclamation-circle"></i> <strong>Erro:</strong> N√£o foi poss√≠vel conectar ao Ollama`;
                statusEl.style.background = '#fee2e2';
                statusEl.style.color = '#991b1b';
            }
        }

        // ========================================
        // Funcoes de IA
        // ========================================
        let isAIEnabled = false;
        let currentProvider = 'groq';

        function toggleAI() {
            isAIEnabled = !isAIEnabled;
            document.getElementById('aiToggle').classList.toggle('active', isAIEnabled);
            document.getElementById('aiConfigSection').style.display = isAIEnabled ? 'block' : 'none';
            updateProviderUI();

            // Auto-salvar quando toggle muda
            saveAISettings();
        }

        function updateProviderUI() {
            const provider = document.getElementById('aiProvider').value;
            currentProvider = provider;

            const badge = document.getElementById('aiProviderBadge');
            const label = document.getElementById('apiKeyLabel');
            const hint = document.getElementById('apiKeyHint');

            if (provider === 'groq') {
                badge.textContent = 'GROQ';
                label.textContent = 'Chave API Groq';
                hint.innerHTML = 'Obtenha em <a href="https://console.groq.com" target="_blank" style="color: #8b5cf6;">console.groq.com</a> (30 req/min gratis)';
            } else {
                badge.textContent = 'GEMINI';
                label.textContent = 'Chave API Gemini';
                hint.innerHTML = 'Obtenha em <a href="https://aistudio.google.com/apikey" target="_blank" style="color: #8b5cf6;">aistudio.google.com</a> (20 req/dia gratis)';
            }
        }

        async function loadAISettings() {
            try {
                const res = await fetch('/api/tenants/me', { headers: API_HEADERS });
                const data = await res.json();
                const aiBot = data.settings?.aiBot || {};

                isAIEnabled = aiBot.enabled || false;
                currentProvider = aiBot.provider || 'groq';

                document.getElementById('aiToggle').classList.toggle('active', isAIEnabled);
                document.getElementById('aiConfigSection').style.display = isAIEnabled ? 'block' : 'none';
                document.getElementById('aiProvider').value = currentProvider;

                if (aiBot.apiKey) {
                    document.getElementById('aiApiKey').value = aiBot.apiKey;
                }

                updateProviderUI();

                // Mostrar status se ativado
                if (isAIEnabled && aiBot.apiKey) {
                    showAIStatus(true, `IA ativa usando ${currentProvider.toUpperCase()}`);
                }
            } catch (e) {
                console.error('Erro ao carregar config IA:', e);
            }
        }

        function showAIStatus(success, message) {
            const status = document.getElementById('aiStatus');
            status.style.display = 'block';
            status.style.background = success ? '#dcfce7' : '#fef2f2';
            status.style.color = success ? '#166534' : '#991b1b';
            status.innerHTML = `<i class="fas fa-${success ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
        }

        async function saveAISettings() {
            const apiKey = document.getElementById('aiApiKey').value.trim();
            const provider = document.getElementById('aiProvider').value;

            if (isAIEnabled && !apiKey) {
                alert('Insira a chave API para habilitar a IA');
                return false;
            }

            try {
                const res = await fetch('/api/whatsapp/settings', {
                    method: 'PUT',
                    headers: { ...API_HEADERS, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        aiBot: {
                            enabled: isAIEnabled,
                            apiKey: apiKey,
                            provider: provider
                        }
                    })
                });

                if (res.ok) {
                    showAIStatus(true, `Configuracoes salvas! IA ${isAIEnabled ? 'ativada' : 'desativada'} (${provider.toUpperCase()})`);
                } else {
                    showAIStatus(false, 'Erro ao salvar configuracoes');
                }
                return true;
            } catch (e) {
                console.error('Erro ao salvar config IA:', e);
                showAIStatus(false, 'Erro ao salvar: ' + e.message);
                return false;
            }
        }

        async function testAI() {
            const apiKey = document.getElementById('aiApiKey').value.trim();
            const provider = document.getElementById('aiProvider').value;

            if (!apiKey) {
                alert('Insira a chave API primeiro');
                return;
            }

            const btn = event.target.closest('button');
            btn.innerHTML = '<i class="fas fa-spinner spinner"></i> Testando...';
            btn.disabled = true;

            try {
                let response;

                if (provider === 'groq') {
                    response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + apiKey
                        },
                        body: JSON.stringify({
                            model: 'llama-3.3-70b-versatile',
                            messages: [{ role: 'user', content: 'Responda apenas: OK' }],
                            max_tokens: 10
                        })
                    });
                } else {
                    response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: 'Responda apenas: OK' }] }]
                        })
                    });
                }

                if (response.ok) {
                    showAIStatus(true, `Conexao com ${provider.toUpperCase()} OK! A IA esta funcionando.`);
                } else {
                    const error = await response.json();
                    showAIStatus(false, 'Erro na API: ' + (error.error?.message || 'Chave invalida'));
                }
            } catch (e) {
                showAIStatus(false, 'Erro ao testar: ' + e.message);
            }

            btn.innerHTML = '<i class="fas fa-flask"></i> TESTAR IA';
            btn.disabled = false;
        }

        // Modificar saveSettings para incluir IA
        const originalSaveSettings = saveSettings;
        saveSettings = async function () {
            await originalSaveSettings();
        };

        // Carregar config IA no init
        const originalInit = init;
        init = async function () {
            await originalInit();
            await loadAISettings();
        };

        init();
    </script>

    <!-- Modal de Configuracao de Mensagens (Redesenhado) -->
    <div id="messageConfigModal"
        style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px;">
        <div
            style="background: var(--card); border: 4px solid var(--dark); border-radius: 20px; width: 100%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 8px 8px 0 var(--dark);">

            <!-- Header -->
            <div
                style="padding: 20px 24px; border-bottom: 3px solid var(--dark); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="font-family: 'Bebas Neue'; font-size: 2rem; display: flex; align-items: center; gap: 12px;">
                    <i class="fab fa-whatsapp" style="color: var(--whatsapp);"></i> Central de Mensagens
                </h2>
                <button onclick="closeMessageConfig()"
                    style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>

            <!-- Tabs Navigation -->
            <div style="display: flex; border-bottom: 3px solid var(--dark); background: var(--bg);">
                <button class="msg-tab active" data-tab="welcome" onclick="switchMsgTab('welcome')">
                    <i class="fas fa-hand-wave"></i> Boas-vindas
                </button>
                <button class="msg-tab" data-tab="orders" onclick="switchMsgTab('orders')">
                    <i class="fas fa-receipt"></i> Pedidos
                </button>
                <button class="msg-tab" data-tab="followup" onclick="switchMsgTab('followup')">
                    <i class="fas fa-clock"></i> Follow-up
                </button>
                <button class="msg-tab" data-tab="triggers" onclick="switchMsgTab('triggers')">
                    <i class="fas fa-bolt"></i> Gatilhos
                </button>
            </div>

            <!-- Tab Content -->
            <div style="flex: 1; overflow-y: auto; padding: 24px;">

                <!-- Tab: Boas-vindas -->
                <div id="tab-welcome" class="msg-tab-content active">
                    <div class="msg-section">
                        <div class="msg-section-header" style="background: linear-gradient(135deg, #25D366, #128C7E);">
                            <i class="fas fa-hand-wave"></i>
                            <div>
                                <strong>Mensagem de Boas-vindas</strong>
                                <small>Enviada quando um novo cliente entra em contato</small>
                            </div>
                        </div>
                        <textarea id="msgWelcome" rows="5" class="msg-textarea">Ola! Bem-vindo ao {restaurante}!

Faca seu pedido pelo link:
{link}

Seu pedido sera enviado diretamente para nos!</textarea>
                        <div class="msg-vars">Variaveis: <span>{restaurante}</span> <span>{link}</span>
                            <span>{nome}</span>
                        </div>
                    </div>

                    <div class="msg-section">
                        <div class="msg-section-header" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                            <i class="fas fa-link"></i>
                            <div>
                                <strong>Mensagem de Link</strong>
                                <small>Enviada ao solicitar o cardapio</small>
                            </div>
                        </div>
                        <textarea id="msgOrderLink" rows="3" class="msg-textarea">Clique no link para fazer seu pedido:
{link}</textarea>
                    </div>

                    <div class="msg-section">
                        <div class="msg-section-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-question-circle"></i>
                            <div>
                                <strong>Mensagem de Ajuda</strong>
                                <small>Instrucoes de como fazer pedido</small>
                            </div>
                        </div>
                        <textarea id="msgHelp" rows="5" class="msg-textarea">Como fazer seu pedido:

1. Clique no link que enviei
2. Monte seu pedido no site
3. Confirme e aguarde a entrega!

Qualquer duvida, estou aqui!</textarea>
                    </div>
                </div>

                <!-- Tab: Pedidos -->
                <div id="tab-orders" class="msg-tab-content" style="display: none;">
                    <div class="msg-section">
                        <div class="msg-section-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-check-circle"></i>
                            <div>
                                <strong>Confirmacao de Pedido</strong>
                                <small>Enviada apos cliente confirmar pedido</small>
                            </div>
                        </div>
                        <textarea id="msgConfirmation" rows="6" class="msg-textarea">Pedido Confirmado! #{numero}

Itens:
{itens}

Total: R$ {total}

Seu pedido esta sendo preparado!</textarea>
                        <div class="msg-vars">Variaveis: <span>{numero}</span> <span>{itens}</span> <span>{total}</span>
                        </div>
                    </div>

                    <div class="info-box" style="margin-top: 16px;">
                        <i class="fas fa-info-circle" style="color: #6366f1;"></i>
                        <div>
                            <strong>Dica:</strong> Use emojis para deixar suas mensagens mais atrativas!
                        </div>
                    </div>
                </div>

                <!-- Tab: Follow-up -->
                <div id="tab-followup" class="msg-tab-content" style="display: none;">
                    <div class="info-box" style="background: #fef3c7; margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle" style="color: #d97706;"></i>
                        <div>
                            <strong>Follow-up Temporariamente Desabilitado</strong><br>
                            <small>O envio automatico esta desativado para ajustes.</small>
                        </div>
                    </div>

                    <div class="msg-section">
                        <div class="msg-section-header" style="background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                            <i class="fas fa-user-clock"></i>
                            <div>
                                <strong>7-14 dias sem pedido</strong>
                                <small>Cliente inativo ha uma semana</small>
                            </div>
                        </div>
                        <textarea id="msgFollowup7" rows="4" class="msg-textarea">Ola {nome}! Sentimos sua falta no {restaurante}!

Que tal um lanche hoje? Estamos com novidades deliciosas esperando por voce!

Faca seu pedido: {link}</textarea>
                    </div>

                    <div class="msg-section">
                        <div class="msg-section-header" style="background: linear-gradient(135deg, #fb923c, #f97316);">
                            <i class="fas fa-calendar-week"></i>
                            <div>
                                <strong>15-30 dias sem pedido</strong>
                                <small>Cliente inativo ha duas semanas</small>
                            </div>
                        </div>
                        <textarea id="msgFollowup15" rows="3" class="msg-textarea">{nome}! Faz um tempinho que voce nao pede no {restaurante}!

Estamos com saudade! Aproveite e mate a vontade:
{link}</textarea>
                    </div>

                    <div class="msg-section">
                        <div class="msg-section-header" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                            <i class="fas fa-calendar-xmark"></i>
                            <div>
                                <strong>31-60 dias sem pedido</strong>
                                <small>Cliente inativo ha mais de um mes</small>
                            </div>
                        </div>
                        <textarea id="msgFollowup30" rows="3" class="msg-textarea">{nome}! Lembra de nos? Somos o {restaurante}!

Voce faz falta aqui! Que tal relembrar nosso sabor?
{link}</textarea>
                    </div>
                </div>

                <!-- Tab: Gatilhos -->
                <div id="tab-triggers" class="msg-tab-content" style="display: none;">
                    <div class="msg-section">
                        <div class="msg-section-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <i class="fas fa-bolt"></i>
                            <div>
                                <strong>Gatilhos de Palavras-Chave</strong>
                                <small>Respostas automaticas para palavras especificas</small>
                            </div>
                        </div>

                        <div style="padding: 16px;">
                            <div id="triggersList" style="margin-bottom: 16px;"></div>

                            <div
                                style="background: var(--bg); padding: 16px; border-radius: 12px; border: 2px solid var(--dark);">
                                <div
                                    style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px; margin-bottom: 12px;">
                                    <div>
                                        <label
                                            style="font-size: 0.75rem; font-weight: 700; margin-bottom: 4px; display: block;">
                                            <i class="fas fa-key"></i> PALAVRA-CHAVE
                                        </label>
                                        <input type="text" id="newTriggerWord" placeholder="ex: cardapio"
                                            style="width: 100%; padding: 12px; border: 2px solid var(--dark); border-radius: 8px; font-size: 1rem;">
                                    </div>
                                    <div>
                                        <label
                                            style="font-size: 0.75rem; font-weight: 700; margin-bottom: 4px; display: block;">
                                            <i class="fas fa-reply"></i> RESPOSTA
                                        </label>
                                        <input type="text" id="newTriggerResponse"
                                            placeholder="Confira nosso cardapio: {link}"
                                            style="width: 100%; padding: 12px; border: 2px solid var(--dark); border-radius: 8px; font-size: 1rem;">
                                    </div>
                                </div>
                                <button class="btn" onclick="addTrigger()"
                                    style="width: 100%; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;">
                                    <i class="fas fa-plus"></i> ADICIONAR GATILHO
                                </button>
                            </div>

                            <div class="info-box" style="margin-top: 16px;">
                                <i class="fas fa-lightbulb" style="color: var(--warning);"></i>
                                <div>
                                    <strong>Dica:</strong> Use palavras simples: "cardapio", "menu", "precos",
                                    "horario".<br>
                                    Use <code
                                        style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px;">{link}</code>
                                    para incluir o link da loja.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div
                style="padding: 16px 24px; border-top: 3px solid var(--dark); display: flex; gap: 12px; justify-content: flex-end; background: var(--bg);">
                <button class="btn btn-secondary" onclick="closeMessageConfig()">
                    <i class="fas fa-times"></i> CANCELAR
                </button>
                <button class="btn btn-whatsapp" onclick="saveMessageConfig()">
                    <i class="fas fa-save"></i> SALVAR TODAS AS MENSAGENS
                </button>
            </div>
        </div>
    </div>

    <style>
        .msg-tab {
            flex: 1;
            padding: 14px 16px;
            border: none;
            background: transparent;
            font-family: 'Outfit', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            color: var(--text-muted);
        }

        .msg-tab:hover {
            background: var(--card);
        }

        .msg-tab.active {
            background: var(--card);
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
            margin-bottom: -3px;
        }

        .msg-tab i {
            font-size: 1rem;
        }

        .msg-tab-content {
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg-section {
            background: var(--card);
            border: 3px solid var(--dark);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .msg-section-header {
            padding: 16px;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .msg-section-header i {
            font-size: 1.5rem;
        }

        .msg-section-header strong {
            display: block;
            font-size: 1rem;
        }

        .msg-section-header small {
            opacity: 0.9;
            font-size: 0.8rem;
        }

        .msg-textarea {
            width: 100%;
            padding: 16px;
            border: none;
            border-top: 2px solid var(--dark);
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            resize: vertical;
            min-height: 100px;
        }

        .msg-vars {
            padding: 8px 16px;
            background: var(--bg);
            font-size: 0.8rem;
            color: var(--text-muted);
            border-top: 2px solid var(--dark);
        }

        .msg-vars span {
            background: #e0e7ff;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 4px;
            font-family: monospace;
        }
    </style>
    <script>
        // ========================================
        // Configuracao de Mensagens
        // ========================================
        let messageConfig = {};
        let triggers = [];

        // Alternar entre abas
        function switchMsgTab(tabName) {
            // Esconder todos os conteudos
            document.querySelectorAll('.msg-tab-content').forEach(el => {
                el.style.display = 'none';
            });
            // Desativar todas as abas
            document.querySelectorAll('.msg-tab').forEach(el => {
                el.classList.remove('active');
            });
            // Mostrar conteudo selecionado
            document.getElementById('tab-' + tabName).style.display = 'block';
            // Ativar aba selecionada
            document.querySelector(`.msg-tab[data-tab="${tabName}"]`).classList.add('active');
        }

        function openMessageConfig() {
            loadMessageConfig();
            document.getElementById('messageConfigModal').style.display = 'flex';
            switchMsgTab('welcome'); // Sempre abrir na primeira aba
        }

        function closeMessageConfig() {
            document.getElementById('messageConfigModal').style.display = 'none';
        }

        async function loadMessageConfig() {
            try {
                const res = await fetch('/api/tenants/me', { headers: API_HEADERS });
                const data = await res.json();
                messageConfig = data.settings?.botMessages || {};
                triggers = data.settings?.triggers || [];

                if (messageConfig.welcome) document.getElementById('msgWelcome').value = messageConfig.welcome;
                if (messageConfig.orderLink) document.getElementById('msgOrderLink').value = messageConfig.orderLink;
                if (messageConfig.help) document.getElementById('msgHelp').value = messageConfig.help;
                if (messageConfig.confirmation) document.getElementById('msgConfirmation').value = messageConfig.confirmation;
                if (messageConfig.followup7) document.getElementById('msgFollowup7').value = messageConfig.followup7;
                if (messageConfig.followup15) document.getElementById('msgFollowup15').value = messageConfig.followup15;
                if (messageConfig.followup30) document.getElementById('msgFollowup30').value = messageConfig.followup30;

                renderTriggers();
            } catch (e) {
                console.error('Erro ao carregar mensagens:', e);
            }
        }

        function renderTriggers() {
            const container = document.getElementById('triggersList');
            if (triggers.length === 0) {
                container.innerHTML = '<div style="padding: 12px; color: var(--text-muted); text-align: center;">Nenhum gatilho configurado</div>';
                return;
            }

            container.innerHTML = triggers.map((t, i) => `
                <div style="display: flex; gap: 12px; align-items: center; padding: 12px; background: var(--card); border: 2px solid var(--dark); border-radius: 8px; margin-bottom: 8px;">
                    <div style="background: #8b5cf6; color: white; padding: 6px 12px; border-radius: 20px; font-weight: 700; font-size: 0.85rem;">
                        ${t.word}
                    </div>
                    <div style="flex: 1; font-size: 0.9rem;">${t.response}</div>
                    <button onclick="removeTrigger(${i})" style="background: var(--danger); color: white; border: none; border-radius: 8px; padding: 8px 12px; cursor: pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function addTrigger() {
            const word = document.getElementById('newTriggerWord').value.trim().toLowerCase();
            const response = document.getElementById('newTriggerResponse').value.trim();

            if (!word || !response) {
                alert('Preencha a palavra-chave e a resposta');
                return;
            }

            // Verificar duplicata
            if (triggers.some(t => t.word === word)) {
                alert('Essa palavra-chave ja existe');
                return;
            }

            triggers.push({ word, response });
            renderTriggers();

            // Limpar campos
            document.getElementById('newTriggerWord').value = '';
            document.getElementById('newTriggerResponse').value = '';
        }

        function removeTrigger(index) {
            triggers.splice(index, 1);
            renderTriggers();
        }

        async function saveMessageConfig() {
            const messages = {
                welcome: document.getElementById('msgWelcome').value,
                orderLink: document.getElementById('msgOrderLink').value,
                help: document.getElementById('msgHelp').value,
                confirmation: document.getElementById('msgConfirmation').value,
                followup7: document.getElementById('msgFollowup7').value,
                followup15: document.getElementById('msgFollowup15').value,
                followup30: document.getElementById('msgFollowup30').value
            };

            try {
                await fetch('/api/whatsapp/settings', {
                    method: 'PUT',
                    headers: { ...API_HEADERS, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        botMessages: messages,
                        triggers: triggers
                    })
                });
                alert('Mensagens e gatilhos salvos com sucesso!');
                closeMessageConfig();
            } catch (e) {
                alert('Erro ao salvar mensagens');
            }
        }

        // Fechar modal ao clicar fora
        document.getElementById('messageConfigModal').addEventListener('click', function (e) {
            if (e.target === this) closeMessageConfig();
        });
    </script>
</body>

</html>